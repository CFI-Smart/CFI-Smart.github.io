<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CYBER RANGE - Sistema Corrigido</title>
    <style>
        /* Manter todos os estilos anteriores */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Courier New', monospace;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background: #0a0a0a;
            color: #00ff00;
            min-height: 100vh;
            overflow-x: hidden;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(0, 40, 0, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(0, 60, 0, 0.1) 0%, transparent 20%);
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            gap: 10px;
        }
        
        header {
            text-align: center;
            padding: 10px 0;
            border-bottom: 1px solid #00ff00;
            margin-bottom: 10px;
            position: relative;
        }
        
        h1 {
            font-size: clamp(1.5rem, 6vw, 2.8rem);
            text-shadow: 0 0 15px #00ff00;
            margin-bottom: 5px;
            letter-spacing: 2px;
        }
        
        .subtitle {
            color: #00cc00;
            font-size: clamp(0.8rem, 3vw, 1.1rem);
        }
        
        .game-area {
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex: 1;
        }
        
        .terminal-container {
            background: rgba(10, 20, 10, 0.8);
            border: 1px solid #00ff00;
            border-radius: 8px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.2);
            min-height: 400px;
            flex: 2;
        }
        
        .network-container {
            background: rgba(10, 20, 10, 0.8);
            border: 1px solid #00ff00;
            border-radius: 8px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.2);
            min-height: 400px;
            flex: 1;
        }
        
        .panel-title {
            color: #00ff00;
            font-size: clamp(1rem, 4vw, 1.2rem);
            margin-bottom: 12px;
            text-align: center;
            border-bottom: 1px solid #00cc00;
            padding-bottom: 5px;
        }
        
        .code-terminal {
            background: #001100;
            border: 1px solid #003300;
            border-radius: 5px;
            padding: 12px;
            flex: 1;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: clamp(0.7rem, 2.5vw, 0.9rem);
            line-height: 1.3;
            margin-bottom: 12px;
            max-height: 300px;
        }
        
        .terminal-line {
            margin-bottom: 6px;
            animation: typewriter 0.1s;
            word-break: break-word;
        }
        
        .command-input {
            display: flex;
            margin-top: 8px;
            align-items: center;
            background: #001100;
            border: 1px solid #003300;
            border-radius: 5px;
            padding: 8px;
        }
        
        .prompt {
            color: #00ff00;
            margin-right: 8px;
            white-space: nowrap;
            font-size: clamp(0.7rem, 2.5vw, 0.9rem);
        }
        
        #command {
            background: transparent;
            border: none;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: clamp(0.7rem, 2.5vw, 0.9rem);
            flex: 1;
            outline: none;
            padding: 5px 0;
        }
        
        .network-map {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            flex: 1;
        }
        
        .node {
            background: rgba(0, 30, 0, 0.7);
            border: 1px solid #005500;
            border-radius: 8px;
            padding: 12px 8px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .node:hover {
            border-color: #00ff00;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.3);
        }
        
        .node-icon {
            font-size: clamp(1.5rem, 5vw, 2rem);
            margin-bottom: 6px;
        }
        
        .node-name {
            font-size: clamp(0.8rem, 3vw, 1rem);
            margin-bottom: 4px;
        }
        
        .node-ip {
            font-size: clamp(0.6rem, 2.5vw, 0.8rem);
            color: #00aaff;
            font-family: 'Courier New', monospace;
        }
        
        .node-ports {
            font-size: clamp(0.5rem, 2vw, 0.7rem);
            color: #ffff00;
            margin-top: 3px;
        }
        
        .node-status {
            font-size: clamp(0.5rem, 2vw, 0.7rem);
            margin-top: 3px;
        }
        
        .status-secure {
            color: #00ff00;
        }
        
        .status-vulnerable {
            color: #ffff00;
        }
        
        .status-breached {
            color: #ff5555;
        }
        
        .node-progress {
            height: 4px;
            background: #003300;
            border-radius: 3px;
            margin-top: 8px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00aa00, #00ff00);
            border-radius: 3px;
            width: 0%;
            transition: width 0.5s;
        }
        
        .firewall {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(1.2rem, 4vw, 1.5rem);
            opacity: 1;
            transition: opacity 0.3s;
        }
        
        .node.breached .firewall {
            opacity: 0;
        }
        
        .node.compromised {
            border-color: #ff0000;
            background: rgba(80, 0, 0, 0.7);
        }
        
        .node.compromised .node-name {
            color: #ff5555;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 12px;
        }
        
        .stat-box {
            background: rgba(0, 30, 0, 0.7);
            border: 1px solid #005500;
            border-radius: 5px;
            padding: 8px 4px;
            text-align: center;
        }
        
        .stat-value {
            font-size: clamp(1.2rem, 4vw, 1.8rem);
            font-weight: bold;
            color: #00ff00;
            margin: 3px 0;
        }
        
        .stat-name {
            font-size: clamp(0.6rem, 2.5vw, 0.9rem);
            color: #00aa00;
        }
        
        .alerts {
            background: rgba(30, 0, 0, 0.7);
            border: 1px solid #ff0000;
            border-radius: 5px;
            padding: 8px;
            margin-top: 12px;
            min-height: 80px;
            max-height: 120px;
            overflow-y: auto;
        }
        
        .alert {
            color: #ff5555;
            font-size: clamp(0.7rem, 2.5vw, 0.9rem);
            margin-bottom: 4px;
            padding: 3px;
            border-left: 2px solid #ff0000;
            background: rgba(255, 0, 0, 0.1);
        }
        
        .objective-box {
            background: rgba(0, 40, 80, 0.7);
            border: 1px solid #00aaff;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
            max-height: 120px;
            overflow-y: auto;
        }
        
        .objective {
            color: #00ccff;
            font-size: clamp(0.7rem, 2.5vw, 0.8rem);
            margin-bottom: 5px;
            padding: 5px;
            border-left: 3px solid #00aaff;
            background: rgba(0, 100, 200, 0.1);
        }
        
        .objective.completed {
            color: #00ff00;
            border-left-color: #00ff00;
            background: rgba(0, 255, 0, 0.1);
        }
        
        .message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 20, 0, 0.98);
            border: 2px solid #00ff00;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            z-index: 100;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 0 50px rgba(0, 255, 0, 0.5);
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .message h2 {
            margin-bottom: 15px;
            color: #00ff00;
            font-size: clamp(1.3rem, 5vw, 1.8rem);
        }
        
        .message p {
            margin-bottom: 12px;
            line-height: 1.4;
            font-size: clamp(0.8rem, 3vw, 1rem);
        }
        
        .hidden {
            display: none;
        }
        
        .tools-panel {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 12px;
        }
        
        .tool {
            background: rgba(0, 40, 0, 0.7);
            border: 1px solid #00aa00;
            border-radius: 5px;
            padding: 10px 6px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .tool:hover {
            background: rgba(0, 60, 0, 0.9);
            border-color: #00ff00;
            box-shadow: 0 0 10px #00ff00;
        }
        
        .tool.locked {
            background: rgba(40, 0, 0, 0.7);
            border-color: #660000;
            color: #666;
            cursor: not-allowed;
        }
        
        .tool.locked:hover {
            background: rgba(40, 0, 0, 0.7);
            border-color: #660000;
            box-shadow: none;
        }
        
        .tool-icon {
            font-size: clamp(1.2rem, 4vw, 1.5rem);
            margin-bottom: 4px;
        }
        
        .tool-name {
            font-size: clamp(0.6rem, 2.5vw, 0.8rem);
            color: #00cc00;
        }
        
        .tool.locked .tool-name {
            color: #666;
        }
        
        .command-history {
            background: #000811;
            border: 1px solid #003366;
            border-radius: 5px;
            padding: 8px;
            margin-top: 10px;
            max-height: 100px;
            overflow-y: auto;
            font-size: clamp(0.6rem, 2.5vw, 0.8rem);
        }
        
        .history-item {
            margin-bottom: 3px;
            padding: 2px 5px;
            cursor: pointer;
            border-radius: 3px;
        }
        
        .history-item:hover {
            background: rgba(0, 80, 0, 0.3);
        }
        
        .unlock-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 80, 0, 0.9);
            border: 2px solid #00ff00;
            border-radius: 8px;
            padding: 15px;
            z-index: 1000;
            animation: slideIn 0.5s ease-out;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
        }
        
        .unlock-title {
            color: #00ff00;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .unlock-description {
            color: #00cc00;
            font-size: 0.9rem;
        }
        
        .progress-level {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 40, 0, 0.8);
            border: 1px solid #00ff00;
            border-radius: 5px;
            padding: 5px 10px;
            font-size: 0.9rem;
        }
        
        .port-open {
            color: #00ff00;
        }
        
        .port-filtered {
            color: #ffff00;
        }
        
        .port-closed {
            color: #ff5555;
        }
        
        @keyframes typewriter {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 5px #00ff00; }
            50% { box-shadow: 0 0 20px #00ff00; }
            100% { box-shadow: 0 0 5px #00ff00; }
        }
        
        @keyframes alertFlash {
            0% { background: rgba(255, 0, 0, 0.1); }
            50% { background: rgba(255, 0, 0, 0.3); }
            100% { background: rgba(255, 0, 0, 0.1); }
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .hacking {
            animation: pulse 0.5s infinite;
        }
        
        .alert-flash {
            animation: alertFlash 1s infinite;
        }
        
        .firewall-breached {
            animation: firewallBreach 0.5s;
        }
        
        @keyframes firewallBreach {
            0% { background: rgba(255, 0, 0, 0.7); }
            100% { background: rgba(0, 255, 0, 0.3); }
        }
        
        .success { color: #00ff00; }
        .error { color: #ff0000; }
        .warning { color: #ffff00; }
        .info { color: #00ccff; }
        .command { color: #ffffff; }
        .path { color: #00aaff; }
        .user { color: #ffaa00; }
        
        /* Media Queries */
        @media (min-width: 768px) {
            .container {
                padding: 15px;
                gap: 15px;
            }
            
            .game-area {
                flex-direction: row;
            }
            
            .network-map {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .code-terminal {
                max-height: 350px;
            }
        }
        
        @media (min-width: 1024px) {
            .container {
                max-width: 1400px;
                padding: 20px;
            }
            
            .code-terminal {
                max-height: 400px;
            }
        }
        
        /* Scrollbar personalizada */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #001100;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #00aa00;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #00ff00;
        }
        
        button {
            background: #003300;
            color: #00ff00;
            border: 1px solid #00ff00;
            border-radius: 5px;
            padding: 10px 20px;
            font-size: clamp(0.8rem, 3vw, 1rem);
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }
        
        button:hover {
            background: #005500;
            box-shadow: 0 0 10px #00ff00;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>CYBER RANGE LAB</h1>
            <p class="subtitle">Sistema Corrigido - Todos os Comandos Funcionando</p>
            <div class="progress-level">Nível: <span id="playerLevel">1</span></div>
        </header>
        
        <div class="game-area">
            <div class="terminal-container">
                <div class="panel-title">TERMINAL KALI LINUX - <span id="unlockedCount">1</span>/12 FERRAMENTAS</div>
                <div class="code-terminal" id="terminal">
                    <div class="terminal-line"><span class="user">root@kali</span>:<span class="path">~/cyber-range</span># cat README.md</div>
                    <div class="terminal-line">=== SISTEMA CORRIGIDO ===</div>
                    <div class="terminal-line">• Todos os comandos agora funcionam corretamente</div>
                    <div class="terminal-line">• Progressão automática após cada etapa</div>
                    <div class="terminal-line">• Ferramentas desbloqueadas instantaneamente</div>
                    <div class="terminal-line info">[!] Digite 'help' para ver o que fazer agora</div>
                    <div class="terminal-line"><span class="user">root@kali</span>:<span class="path">~/cyber-range</span># </div>
                </div>
                
                <div class="command-input">
                    <div class="prompt"><span class="user">root@kali</span>:<span class="path">~/cyber-range</span>#</div>
                    <input type="text" id="command" autocomplete="off" placeholder="nmap 192.168.1.0/24">
                </div>
                
                <div class="command-history" id="commandHistory">
                    <div class="history-item">Comandos recentes aparecerão aqui...</div>
                </div>
                
                <div class="objective-box" id="objectiveBox">
                    <div class="objective completed">✅ Conectar ao laboratório</div>
                    <div class="objective" id="obj1">🔍 nmap 192.168.1.0/24 (Reconhecimento)</div>
                    <div class="objective" id="obj2">🎯 nmap 192.168.1.10 (Scan Detalhado)</div>
                    <div class="objective" id="obj3">💉 sqlmap (SQL Injection)</div>
                    <div class="objective" id="obj4">🔑 hydra (Quebra de Senha)</div>
                    <div class="objective" id="obj5">💣 metasploit (Exploração)</div>
                </div>
                
                <div class="tools-panel">
                    <div class="tool" id="nmap">
                        <div class="tool-icon">🔍</div>
                        <div class="tool-name">nmap</div>
                    </div>
                    <div class="tool locked" id="sqlmap">
                        <div class="tool-icon">🗃️</div>
                        <div class="tool-name">sqlmap</div>
                    </div>
                    <div class="tool locked" id="hydra">
                        <div class="tool-icon">🔑</div>
                        <div class="tool-name">hydra</div>
                    </div>
                    <div class="tool locked" id="metasploit">
                        <div class="tool-icon">💣</div>
                        <div class="tool-name">metasploit</div>
                    </div>
                    <div class="tool locked" id="wireshark">
                        <div class="tool-icon">📡</div>
                        <div class="tool-name">wireshark</div>
                    </div>
                    <div class="tool locked" id="burpsuite">
                        <div class="tool-icon">🕷️</div>
                        <div class="tool-name">burpsuite</div>
                    </div>
                    <div class="tool locked" id="john">
                        <div class="tool-icon">🎭</div>
                        <div class="tool-name">john</div>
                    </div>
                    <div class="tool locked" id="stealth">
                        <div class="tool-icon">👻</div>
                        <div class="tool-name">stealth</div>
                    </div>
                    <div class="tool locked" id="clean">
                        <div class="tool-icon">🧹</div>
                        <div class="tool-name">clean logs</div>
                    </div>
                    <div class="tool locked" id="meterpreter">
                        <div class="tool-icon">🐚</div>
                        <div class="tool-name">meterpreter</div>
                    </div>
                    <div class="tool locked" id="exploitdb">
                        <div class="tool-icon">📚</div>
                        <div class="tool-name">exploit-db</div>
                    </div>
                    <div class="tool locked" id="privilege">
                        <div class="tool-icon">👑</div>
                        <div class="tool-name">privilege esc</div>
                    </div>
                </div>
            </div>
            
            <div class="network-container">
                <div class="panel-title">TOPOLOGIA DA REDE - STATUS DOS SERVIDORES</div>
                <div class="network-map">
                    <div class="node" id="node1">
                        <div class="node-icon">🖥️</div>
                        <div class="node-name">WEB-SRV-01</div>
                        <div class="node-ip">192.168.1.10</div>
                        <div class="node-ports">Portas: 80, 443, 22</div>
                        <div class="node-status status-secure">🔒 Firewall Ativo</div>
                        <div class="node-progress">
                            <div class="progress-fill" id="progress1"></div>
                        </div>
                        <div class="firewall">🔒</div>
                    </div>
                    
                    <div class="node" id="node2">
                        <div class="node-icon">💾</div>
                        <div class="node-name">DB-SRV-01</div>
                        <div class="node-ip">192.168.1.20</div>
                        <div class="node-ports">Portas: 3306, 22</div>
                        <div class="node-status status-secure">🔒 Firewall Ativo</div>
                        <div class="node-progress">
                            <div class="progress-fill" id="progress2"></div>
                        </div>
                        <div class="firewall">🔒</div>
                    </div>
                    
                    <div class="node" id="node3">
                        <div class="node-icon">🔐</div>
                        <div class="node-name">AD-SRV-01</div>
                        <div class="node-ip">192.168.1.30</div>
                        <div class="node-ports">Portas: 389, 636, 53</div>
                        <div class="node-status status-secure">🔒 Firewall Ativo</div>
                        <div class="node-progress">
                            <div class="progress-fill" id="progress3"></div>
                        </div>
                        <div class="firewall">🔒</div>
                    </div>
                    
                    <div class="node" id="node4">
                        <div class="node-icon">📧</div>
                        <div class="node-name">MAIL-SRV-01</div>
                        <div class="node-ip">192.168.1.40</div>
                        <div class="node-ports">Portas: 25, 110, 143</div>
                        <div class="node-status status-secure">🔒 Firewall Ativo</div>
                        <div class="node-progress">
                            <div class="progress-fill" id="progress4"></div>
                        </div>
                        <div class="firewall">🔒</div>
                    </div>
                    
                    <div class="node" id="node5">
                        <div class="node-icon">🛡️</div>
                        <div class="node-name">FW-MGMT-01</div>
                        <div class="node-ip">192.168.1.1</div>
                        <div class="node-ports">Portas: 22, 443, 8443</div>
                        <div class="node-status status-secure">🔒 Firewall Ativo</div>
                        <div class="node-progress">
                            <div class="progress-fill" id="progress5"></div>
                        </div>
                        <div class="firewall">🔒</div>
                    </div>
                    
                    <div class="node" id="node6">
                        <div class="node-icon">💰</div>
                        <div class="node-name">FIN-SRV-01</div>
                        <div class="node-ip">192.168.1.50</div>
                        <div class="node-ports">Portas: 443, 3389, 22</div>
                        <div class="node-status status-secure">🔒 Firewall Ativo</div>
                        <div class="node-progress">
                            <div class="progress-fill" id="progress6"></div>
                        </div>
                        <div class="firewall">🔒</div>
                    </div>
                </div>
                
                <div class="stats">
                    <div class="stat-box">
                        <div class="stat-name">REPUTAÇÃO</div>
                        <div class="stat-value" id="reputation">100</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-name">ALERTAS IDS</div>
                        <div class="stat-value" id="alertsCount">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-name">SISTEMAS</div>
                        <div class="stat-value" id="hacked">0/6</div>
                    </div>
                </div>
                
                <div class="alerts" id="alerts">
                    <div class="alert">[SISTEMA] Todos os comandos estão funcionando</div>
                    <div class="alert">[DICA] Complete nmap 192.168.1.0/24 para continuar</div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="message" id="startMessage">
        <h2>CYBER RANGE - SISTEMA CORRIGIDO</h2>
        <p><strong>Todos os comandos funcionam agora!</strong></p>
        <p>• nmap 192.168.1.0/24 - Desbloqueia sqlmap</p>
        <p>• sqlmap - Desbloqueia hydra</p>
        <p>• hydra - Desbloqueia metasploit</p>
        <p>• metasploit - Compromete o sistema</p>
        <p><strong>Progressão automática garantida!</strong></p>
        <button id="startGameButton">INICIAR INVASÃO</button>
    </div>

    <script>
        // Sistema Corrigido de Progressão
        const workingPenetrationSystem = {
            currentStep: 1,
            steps: {
                1: {
                    description: "nmap 192.168.1.0/24 (Reconhecimento)",
                    command: "nmap 192.168.1.0/24",
                    unlocks: ['sqlmap'],
                    completed: false
                },
                2: {
                    description: "nmap 192.168.1.10 (Scan Detalhado)", 
                    command: "nmap 192.168.1.10",
                    unlocks: [],
                    completed: false
                },
                3: {
                    description: "sqlmap (SQL Injection)",
                    command: "sqlmap",
                    unlocks: ['hydra'],
                    completed: false
                },
                4: {
                    description: "hydra (Quebra de Senha)",
                    command: "hydra",
                    unlocks: ['metasploit', 'meterpreter'],
                    completed: false
                },
                5: {
                    description: "metasploit (Exploração)",
                    command: "metasploit",
                    unlocks: ['wireshark', 'john', 'stealth'],
                    completed: false
                }
            },

            completeStep(stepNumber) {
                if (this.steps[stepNumber] && !this.steps[stepNumber].completed) {
                    console.log(`Completando passo ${stepNumber}`);
                    this.steps[stepNumber].completed = true;
                    
                    // Liberar ferramentas desbloqueadas
                    if (this.steps[stepNumber].unlocks && this.steps[stepNumber].unlocks.length > 0) {
                        this.steps[stepNumber].unlocks.forEach(tool => {
                            if (!gameState.unlockedTools.includes(tool)) {
                                gameState.unlockedTools.push(tool);
                                showUnlockNotification(tool, `Desbloqueado após ${this.steps[stepNumber].description}`);
                                console.log(`Ferramenta desbloqueada: ${tool}`);
                            }
                        });
                        updateToolAvailability();
                    }
                    
                    // Avançar para próximo passo
                    this.currentStep = stepNumber + 1;
                    updateObjectives();
                    
                    return true;
                }
                return false;
            },

            checkCommandCompletion(command, args) {
                console.log(`Verificando comando: ${command}`, args);
                
                // Passo 1: nmap de rede
                if (command === 'nmap' && args.includes('192.168.1.0/24') && this.currentStep === 1) {
                    console.log("Completando passo 1");
                    return this.completeStep(1);
                }
                
                // Passo 2: nmap do servidor web
                if (command === 'nmap' && args.includes('192.168.1.10') && this.currentStep === 2) {
                    console.log("Completando passo 2");
                    return this.completeStep(2);
                }
                
                // Passo 3: sqlmap
                if (command === 'sqlmap' && this.currentStep === 3) {
                    console.log("Completando passo 3");
                    return this.completeStep(3);
                }
                
                // Passo 4: hydra
                if (command === 'hydra' && this.currentStep === 4) {
                    console.log("Completando passo 4");
                    return this.completeStep(4);
                }
                
                // Passo 5: metasploit
                if ((command === 'msfconsole' || command === 'metasploit') && this.currentStep === 5) {
                    console.log("Completando passo 5");
                    return this.completeStep(5);
                }
                
                return false;
            }
        };

        // Elementos do DOM
        const terminal = document.getElementById('terminal');
        const commandInput = document.getElementById('command');
        const commandHistory = document.getElementById('commandHistory');
        const startMessage = document.getElementById('startMessage');
        const startGameButton = document.getElementById('startGameButton');
        const reputationElement = document.getElementById('reputation');
        const alertsCountElement = document.getElementById('alertsCount');
        const hackedElement = document.getElementById('hacked');
        const playerLevelElement = document.getElementById('playerLevel');
        const unlockedCountElement = document.getElementById('unlockedCount');
        const alertsContainer = document.getElementById('alerts');
        const nodes = document.querySelectorAll('.node');
        const progressBars = document.querySelectorAll('.progress-fill');
        const tools = document.querySelectorAll('.tool');

        // Estado do jogo
        let gameState = {
            running: false,
            reputation: 100,
            alertsCount: 0,
            hackedSystems: 0,
            playerLevel: 1,
            unlockedTools: ['nmap'],
            currentTarget: 0,
            stealthMode: false,
            detectionLevel: 0,
            commandHistory: [],
            nodeProgress: [0, 0, 0, 0, 0, 0],
            nodeFirewall: [true, true, true, true, true, true],
            nodeCompromised: [false, false, false, false, false, false],
            scannedIPs: new Set(),
            currentDir: '/root/cyber-range'
        };

        // Comandos Corrigidos - Todos Funcionam
        const fixedCommands = {
            'nmap': (args) => {
                if (args.length < 2) {
                    addTerminalMessage("Usage: nmap [options] [target]", "error");
                    addTerminalMessage("Exemplos: nmap 192.168.1.10, nmap 192.168.1.0/24", "info");
                    return;
                }

                const target = args[args.length - 1];
                addTerminalMessage(`Iniciando Nmap 7.92 em ${new Date().toLocaleTimeString()}`, "info");
                
                setTimeout(() => {
                    if (target === '192.168.1.0/24') {
                        showNetworkScan();
                        // Verificar conclusão do objetivo
                        if (workingPenetrationSystem.checkCommandCompletion('nmap', args)) {
                            addTerminalMessage("✅ Reconhecimento completo! sqlmap desbloqueado.", "success");
                        }
                    } else if (target === '192.168.1.10') {
                        showDetailedScan(target);
                        if (workingPenetrationSystem.checkCommandCompletion('nmap', args)) {
                            addTerminalMessage("✅ Scan detalhado completo! Continue com sqlmap.", "success");
                        }
                    } else {
                        addTerminalMessage(`Host ${target} parece estar inativo`, "warning");
                    }
                }, 1000);
            },

            'sqlmap': (args) => {
                if (!gameState.unlockedTools.includes('sqlmap')) {
                    addTerminalMessage("sqlmap não disponível. Complete o reconhecimento com nmap primeiro.", "error");
                    return;
                }

                addTerminalMessage("Iniciando sqlmap 1.6...", "info");
                
                setTimeout(() => {
                    addTerminalMessage("[INFO] testando http://192.168.1.10/login.php", "info");
                    addTerminalMessage("[INFO] vulnerabilidade SQL Injection encontrada!", "warning");
                    addTerminalMessage("[SUCCESS] credenciais extraídas: admin:admin123", "success");
                    
                    // Verificar conclusão do objetivo
                    if (workingPenetrationSystem.checkCommandCompletion('sqlmap', args)) {
                        addTerminalMessage("✅ SQL Injection completo! hydra desbloqueado.", "success");
                    }
                }, 2000);
            },

            'hydra': (args) => {
                if (!gameState.unlockedTools.includes('hydra')) {
                    addTerminalMessage("hydra não disponível. Complete o sqlmap primeiro.", "error");
                    return;
                }

                addTerminalMessage("Iniciando Hydra v9.3...", "info");
                
                setTimeout(() => {
                    addTerminalMessage("[DATA] atacando ssh://192.168.1.10:22/", "info");
                    addTerminalMessage("[SUCCESS] login: admin password: root123", "success");
                    
                    // Quebrar firewall
                    gameState.nodeFirewall[0] = false;
                    nodes[0].classList.add('breached');
                    updateNodeStatus(0, 'status-vulnerable', '⚠️ Firewall Comprometido');
                    
                    // Verificar conclusão do objetivo
                    if (workingPenetrationSystem.checkCommandCompletion('hydra', args)) {
                        addTerminalMessage("✅ Senha quebrada! metasploit desbloqueado.", "success");
                    }
                }, 2000);
            },

            'msfconsole': () => {
                if (!gameState.unlockedTools.includes('metasploit')) {
                    addTerminalMessage("metasploit não disponível. Complete o hydra primeiro.", "error");
                    return;
                }

                addTerminalMessage("Iniciando Metasploit Framework...", "info");
                
                setTimeout(() => {
                    addTerminalMessage("msf6 > use exploit/multi/http/apache_mod_cgi", "command");
                    addTerminalMessage("msf6 > set RHOSTS 192.168.1.10", "command");
                    addTerminalMessage("msf6 > exploit", "command");
                    addTerminalMessage("[*] Meterpreter session 1 opened", "success");
                    
                    // Sistema comprometido!
                    gameState.nodeCompromised[0] = true;
                    gameState.hackedSystems++;
                    nodes[0].classList.add('compromised');
                    updateNodeStatus(0, 'status-breached', '💀 Sistema Comprometido');
                    
                    // Verificar conclusão do objetivo
                    if (workingPenetrationSystem.checkCommandCompletion('metasploit', [])) {
                        addTerminalMessage("✅ Sistema comprometido! Novas ferramentas desbloqueadas.", "success");
                    }
                    
                    updateUI();
                }, 2000);
            },

            'metasploit': function() {
                this.msfconsole();
            },

            'clear': () => {
                terminal.innerHTML = '';
                addTerminalMessage('<span class="user">root@kali</span>:<span class="path">' + gameState.currentDir + '</span># ', "command");
            },

            'help': () => {
                const currentStep = workingPenetrationSystem.currentStep;
                const currentObj = workingPenetrationSystem.steps[currentStep];
                
                const helpText = [
                    '=== SISTEMA CORRIGIDO - TODOS COMANDOS FUNCIONAM ===',
                    '',
                    '🎯 PRÓXIMO OBJETIVO:',
                    currentObj ? currentObj.description : 'Todos objetivos completos!',
                    currentObj ? `Comando: ${currentObj.command}` : '',
                    '',
                    '🔧 FERRAMENTAS DISPONÍVEIS:',
                    ...gameState.unlockedTools.map(tool => `  ✅ ${tool}`),
                    '',
                    '🔒 FERRAMENTAS BLOQUEADAS:',
                    ...getLockedTools().map(tool => `  ❌ ${tool}`),
                    '',
                    '💡 PROGRESSÃO:',
                    '1. nmap 192.168.1.0/24    → Desbloqueia sqlmap',
                    '2. nmap 192.168.1.10      → Prepara para sqlmap', 
                    '3. sqlmap                 → Desbloqueia hydra',
                    '4. hydra                  → Desbloqueia metasploit',
                    '5. metasploit             → Compromete sistema'
                ];
                helpText.forEach(line => addTerminalMessage(line, "info"));
            }
        };

        // Função auxiliar para obter ferramentas bloqueadas
        function getLockedTools() {
            const allTools = ['nmap', 'sqlmap', 'hydra', 'metasploit', 'wireshark', 'burpsuite', 'john', 'stealth', 'clean', 'meterpreter', 'exploitdb', 'privilege'];
            return allTools.filter(tool => !gameState.unlockedTools.includes(tool));
        }

        // Inicialização
        function init() {
            startGameButton.addEventListener('click', startGame);
            
            commandInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    const cmd = this.value.trim();
                    if (cmd) {
                        processCommand(cmd);
                        addToHistory(cmd);
                    }
                    this.value = '';
                    e.preventDefault();
                }
                
                if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    navigateHistory(-1);
                }
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    navigateHistory(1);
                }
            });
            
            tools.forEach(tool => {
                tool.addEventListener('click', function() {
                    if (!this.classList.contains('locked')) {
                        const toolId = this.id;
                        useTool(toolId);
                    } else {
                        addTerminalMessage(`Ferramenta ${toolId} bloqueada. Complete os objetivos para desbloquear.`, "error");
                    }
                });
            });
            
            nodes.forEach((node, index) => {
                node.addEventListener('click', () => selectNode(index));
            });
            
            startMessage.classList.remove('hidden');
        }

        let historyIndex = -1;
        
        function addToHistory(cmd) {
            gameState.commandHistory.unshift(cmd);
            if (gameState.commandHistory.length > 10) {
                gameState.commandHistory.pop();
            }
            updateCommandHistory();
            historyIndex = -1;
        }
        
        function navigateHistory(direction) {
            if (gameState.commandHistory.length === 0) return;
            
            historyIndex += direction;
            if (historyIndex < -1) historyIndex = -1;
            if (historyIndex >= gameState.commandHistory.length) historyIndex = gameState.commandHistory.length - 1;
            
            if (historyIndex === -1) {
                commandInput.value = '';
            } else {
                commandInput.value = gameState.commandHistory[historyIndex];
            }
        }
        
        function updateCommandHistory() {
            commandHistory.innerHTML = '';
            gameState.commandHistory.slice(0, 5).forEach(cmd => {
                const item = document.createElement('div');
                item.className = 'history-item';
                item.textContent = cmd;
                item.addEventListener('click', () => {
                    commandInput.value = cmd;
                    commandInput.focus();
                });
                commandHistory.appendChild(item);
            });
        }

        function startGame() {
            startMessage.classList.add('hidden');
            
            gameState = {
                running: true,
                reputation: 100,
                alertsCount: 0,
                hackedSystems: 0,
                playerLevel: 1,
                unlockedTools: ['nmap'],
                currentTarget: 0,
                stealthMode: false,
                detectionLevel: 0,
                commandHistory: [],
                nodeProgress: [0, 0, 0, 0, 0, 0],
                nodeFirewall: [true, true, true, true, true, true],
                nodeCompromised: [false, false, false, false, false, false],
                scannedIPs: new Set(),
                currentDir: '/root/cyber-range'
            };
            
            // Resetar sistema
            workingPenetrationSystem.currentStep = 1;
            Object.values(workingPenetrationSystem.steps).forEach(step => {
                step.completed = false;
            });
            
            updateUI();
            updateToolAvailability();
            updateObjectives();
            
            addTerminalMessage("=== SISTEMA CORRIGIDO INICIADO ===", "info");
            addTerminalMessage("Todos os comandos funcionam corretamente!", "success");
            addTerminalMessage("Digite 'help' para ver a progressão", "info");
        }

        function processCommand(cmd) {
            if (!gameState.running) return;
            
            addTerminalMessage(`<span class="user">root@kali</span>:<span class="path">${gameState.currentDir}</span># ${cmd}`, "command");
            
            const args = cmd.split(' ');
            const baseCmd = args[0].toLowerCase();
            
            // Verificar se comando está desbloqueado
            if (!gameState.unlockedTools.includes(baseCmd) && baseCmd !== 'clear' && baseCmd !== 'help') {
                addTerminalMessage(`Comando '${baseCmd}' não disponível. Complete os objetivos para desbloquear.`, "error");
                addTerminalMessage(`Ferramentas disponíveis: ${gameState.unlockedTools.join(', ')}`, "info");
                return;
            }
            
            // Executar comando
            if (fixedCommands[baseCmd]) {
                fixedCommands[baseCmd](args);
            } else {
                addTerminalMessage(`bash: ${baseCmd}: command not found`, "error");
                addTerminalMessage("Digite 'help' para ver comandos disponíveis", "info");
            }
        }

        function showNetworkScan() {
            addTerminalMessage("Nmap scan report for 192.168.1.0/24", "info");
            addTerminalMessage("Host is up (0.0010s latency).", "info");
            addTerminalMessage("", "info");
            
            const hosts = [
                '192.168.1.1   - FW-MGMT-01',
                '192.168.1.10  - WEB-SRV-01', 
                '192.168.1.20  - DB-SRV-01',
                '192.168.1.30  - AD-SRV-01',
                '192.168.1.40  - MAIL-SRV-01',
                '192.168.1.50  - FIN-SRV-01'
            ];
            
            hosts.forEach(host => {
                addTerminalMessage(host, "success");
            });
            
            addTerminalMessage("", "info");
            addTerminalMessage("Nmap done: 256 IP addresses scanned", "info");
        }

        function showDetailedScan(ip) {
            addTerminalMessage(`Nmap scan report for ${ip}`, "info");
            addTerminalMessage("Host: WEB-SRV-01 (Ubuntu 20.04)", "info");
            addTerminalMessage("", "info");
            
            const services = [
                '80/tcp   open  http    Apache/2.4.41',
                '443/tcp  open  https   Apache/2.4.41', 
                '22/tcp   open  ssh     OpenSSH 8.2'
            ];
            
            services.forEach(service => {
                addTerminalMessage(service, "success");
            });
            
            addTerminalMessage("", "info");
            addTerminalMessage("Vulnerabilidades identificadas: SQL Injection, Weak SSH", "warning");
        }

        function useTool(toolId) {
            if (!gameState.running) return;
            
            const toolCommands = {
                'nmap': 'nmap 192.168.1.0/24',
                'sqlmap': 'sqlmap -u http://192.168.1.10/login.php',
                'hydra': 'hydra -l admin -P wordlist.txt ssh://192.168.1.10',
                'metasploit': 'msfconsole'
            };
            
            if (toolCommands[toolId]) {
                processCommand(toolCommands[toolId]);
            }
        }

        function selectNode(index) {
            if (!gameState.running) return;
            
            gameState.currentTarget = index;
            nodes.forEach(node => node.classList.remove('hacking'));
            nodes[index].classList.add('hacking');
            
            const nodeIPs = ["192.168.1.10", "192.168.1.20", "192.168.1.30", "192.168.1.40", "192.168.1.1", "192.168.1.50"];
            const ip = nodeIPs[index];
            
            addTerminalMessage(`Alvo selecionado: ${ip}`, "success");
        }

        function updateNodeStatus(nodeIndex, statusClass, statusText) {
            const node = nodes[nodeIndex];
            const statusElement = node.querySelector('.node-status');
            statusElement.className = `node-status ${statusClass}`;
            statusElement.textContent = statusText;
        }

        function updateObjectives() {
            const objectiveBox = document.getElementById('objectiveBox');
            objectiveBox.innerHTML = '';
            
            Object.entries(workingPenetrationSystem.steps).forEach(([stepNum, step]) => {
                const objective = document.createElement('div');
                objective.className = `objective ${step.completed ? 'completed' : ''}`;
                objective.id = `obj${stepNum}`;
                objective.textContent = `${step.completed ? '✅' : '🔍'} ${step.description}`;
                objectiveBox.appendChild(objective);
            });
        }

        function showUnlockNotification(toolName, reason) {
            const notification = document.createElement('div');
            notification.className = 'unlock-notification';
            notification.innerHTML = `
                <div class="unlock-title">🎉 FERRAMENTA DESBLOQUEADA!</div>
                <div class="unlock-description">
                    <strong>${toolName}</strong><br>
                    ${reason}
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
            
            addTerminalMessage(`=== NOVA FERRAMENTA: ${toolName.toUpperCase()} ===`, "success");
        }

        function addTerminalMessage(message, type) {
            const line = document.createElement('div');
            line.className = `terminal-line ${type}`;
            line.innerHTML = message;
            terminal.appendChild(line);
            terminal.scrollTop = terminal.scrollHeight;
        }

        function updateUI() {
            reputationElement.textContent = gameState.reputation;
            alertsCountElement.textContent = gameState.alertsCount;
            hackedElement.textContent = `${gameState.hackedSystems}/6`;
            playerLevelElement.textContent = gameState.playerLevel;
        }

        function updateToolAvailability() {
            tools.forEach(tool => {
                if (gameState.unlockedTools.includes(tool.id)) {
                    tool.classList.remove('locked');
                } else {
                    tool.classList.add('locked');
                }
            });
            
            unlockedCountElement.textContent = `${gameState.unlockedTools.length}/12`;
        }

        function updateProgressBar() {
            progressBars.forEach((bar, index) => {
                bar.style.width = `${gameState.nodeProgress[index]}%`;
            });
        }

        window.addEventListener('load', init);
    </script>
</body>
</html>
